name: 同步Fork与上游仓库

on:
 schedule:
   - cron: "0 0 * * *"    # 每天凌晨零点执行
 workflow_dispatch:

env:
 UPSTREAM_REPO: "jaywcjlove/reference"
 UPSTREAM_BRANCH: "gh-pages"

jobs:
 sync:
   runs-on: ubuntu-latest
   steps:
     - name: 检出Fork仓库
       uses: actions/checkout@v4
       with:
         fetch-depth: 0
         token: ${{ secrets.GITHUB_TOKEN }}
         ref: gh-pages

     - name: 配置Git用户信息
       run: |
         git config user.name 'github-actions[bot]'
         git config user.email 'github-actions[bot]@users.noreply.github.com'

     - name: 添加上游仓库
       run: |
         if git remote get-url upstream >/dev/null 2>&1; then
           git remote set-url upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
         else
           git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
         fi
         git fetch upstream ${{ env.UPSTREAM_BRANCH }}

     - name: 检查是否需要同步
       id: check_sync_needed
       run: |
         git fetch origin gh-pages
         if git diff --quiet origin/gh-pages upstream/${{ env.UPSTREAM_BRANCH }}; then
           echo "needs_sync=false" >> $GITHUB_OUTPUT
           echo "✅ 仓库已是最新，无需同步"
         else
           echo "needs_sync=true" >> $GITHUB_OUTPUT
           echo "🔄 检测到更新，开始同步"
         fi

     - name: 强制同步上游仓库
       if: steps.check_sync_needed.outputs.needs_sync == 'true'
       run: |
         git checkout gh-pages
         git reset --hard upstream/${{ env.UPSTREAM_BRANCH }}
         echo "✅ 强制同步完成"

     - name: 推送更新到Fork仓库
       if: steps.check_sync_needed.outputs.needs_sync == 'true'
       run: |
         git push --force-with-lease origin gh-pages
         echo "🚀 推送完成"
